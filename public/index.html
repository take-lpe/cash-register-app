<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ¬ã‚¸é‡‘ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { text-align: center; color: #333; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå…¥åŠ›æ¬„ã¨è¨ˆç®—çµæœã‚’æ¨ªä¸¦ã³ã« */
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .input-section { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .history-section { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* é‡‘ç¨®å…¥åŠ›ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .money-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .money-row label { width: 100px; font-weight: bold; }
        .money-row input { width: 80px; text-align: right; padding: 5px; }
        
        /* é‡è¦ãªæ•°å­—ã‚’ç›®ç«‹ãŸã›ã‚‹ */
        .total-display { font-size: 1.2em; border-top: 2px solid #333; margin-top: 10px; padding-top: 10px; }
        .diff-display { font-size: 1.5em; font-weight: bold; text-align: center; margin: 20px 0; padding: 10px; background: #eee; border-radius: 5px; }
        
        /* å·®é¡ã®è‰²åˆ†ã‘ */
        .plus { color: blue; }
        .minus { color: red; }
        .zero { color: green; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #eee; text-align: center; }
        button { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
        button:hover { background-color: #218838; }
        .del-btn { background-color: #dc3545; width: auto; padding: 2px 8px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>ğŸ’° ãƒ¬ã‚¸é‡‘ç®¡ç†ã‚¢ãƒ—ãƒª</h1>

    <div class="container">
        <div class="input-section">
            <h2>æœ¬æ—¥ã®ãƒ¬ã‚¸ç· ã‚</h2>
            
            <div class="money-row">
                <label>æ—¥ä»˜</label>
                <input type="date" id="input-date">
            </div>

            <hr>
            <h3>ç¾é‡‘ã‚«ã‚¦ãƒ³ãƒˆ</h3>
            <div class="money-row"><label>10,000å††</label> x <input type="number" class="cash-count" data-val="10000" oninput="calc()"></div>
            <div class="money-row"><label>5,000å††</label> x <input type="number" class="cash-count" data-val="5000" oninput="calc()"></div>
            <div class="money-row"><label>1,000å††</label> x <input type="number" class="cash-count" data-val="1000" oninput="calc()"></div>
            <div class="money-row"><label>500å††</label> x <input type="number" class="cash-count" data-val="500" oninput="calc()"></div>
            <div class="money-row"><label>100å††</label> x <input type="number" class="cash-count" data-val="100" oninput="calc()"></div>
            <div class="money-row"><label>50å††</label> x <input type="number" class="cash-count" data-val="50" oninput="calc()"></div>
            <div class="money-row"><label>10å††</label> x <input type="number" class="cash-count" data-val="10" oninput="calc()"></div>
            <div class="money-row"><label>5å††</label> x <input type="number" class="cash-count" data-val="5" oninput="calc()"></div>
            <div class="money-row"><label>1å††</label> x <input type="number" class="cash-count" data-val="1" oninput="calc()"></div>

            <div class="total-display">
                æ‰‹å…ƒã®ç¾é‡‘åˆè¨ˆ: <span id="display-cash-total">0</span> å††
            </div>

            <hr>
            <div class="money-row">
                <label>ãƒ¬ã‚¸ä¸Šã®å£²ä¸Š</label>
                <input type="number" id="input-system" placeholder="ãƒ¬ã‚¸ã®æ•°å­—ã‚’å…¥åŠ›" oninput="calc()">
            </div>

            <div id="diff-area" class="diff-display zero">å·®é¡: 0 å††</div>

            <textarea id="input-memo" placeholder="å‚™è€ƒãƒ»ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šãŠé‡£ã‚Šã‚’è£œå……ã—ãŸã€ãªã©ï¼‰" style="width: 95%; height: 60px;"></textarea>
            
            <br><br>
            <button onclick="saveRecord()">è¨˜éŒ²ã™ã‚‹</button>
        </div>

        <div class="history-section">
            <h2>éå»ã®å±¥æ­´</h2>
            <table>
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>å·®é¡</th>
                        <th>å®Ÿé‡‘</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="history-list">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸã‚»ãƒƒãƒˆ
        document.getElementById('input-date').valueAsDate = new Date();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚’å–å¾—
        window.onload = loadHistory;

        // â˜…è‡ªå‹•è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calc() {
            // 1. ç¾é‡‘ã®åˆè¨ˆã‚’è¨ˆç®—
            let cashTotal = 0;
            // class="cash-count" ãŒã¤ã„ã¦ã„ã‚‹å…¥åŠ›æ¬„ã‚’å…¨éƒ¨é›†ã‚ã‚‹
            const inputs = document.querySelectorAll('.cash-count');
            inputs.forEach(input => {
                const val = Number(input.getAttribute('data-val')); // 10000å††ãªã©ã®å˜ä¾¡
                const count = Number(input.value); // æšæ•°
                cashTotal += val * count;
            });

            // 2. ç”»é¢ã«è¡¨ç¤º
            document.getElementById('display-cash-total').innerText = cashTotal.toLocaleString();

            // 3. å·®é¡ã‚’è¨ˆç®—ï¼ˆæ‰‹å…ƒã®ç¾é‡‘ - ãƒ¬ã‚¸ã®å£²ä¸Šï¼‰
            const systemVal = Number(document.getElementById('input-system').value);
            const diff = cashTotal - systemVal;
            
            // 4. å·®é¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³åˆ¶å¾¡
            const diffArea = document.getElementById('diff-area');
            diffArea.innerText = `å·®é¡: ${diff.toLocaleString()} å††`;
            
            diffArea.className = 'diff-display'; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (diff > 0) diffArea.classList.add('plus');       // å¤šã„å ´åˆï¼šé’
            else if (diff < 0) diffArea.classList.add('minus'); // ä¸è¶³ã®å ´åˆï¼šèµ¤
            else diffArea.classList.add('zero');                // ã´ã£ãŸã‚Šã®å ´åˆï¼šç·‘
            
            return { cashTotal, systemVal };
        }

        // â˜…ä¿å­˜å‡¦ç†
        async function saveRecord() {
            const date = document.getElementById('input-date').value;
            const { cashTotal, systemVal } = calc(); // è¨ˆç®—çµæœã‚’ã‚‚ã‚‰ã†
            const memo = document.getElementById('input-memo').value;

            if (!date) return alert("æ—¥ä»˜ã‚’å…¥ã‚Œã¦ãã ã•ã„");

            await fetch('/api/registers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: date,
                    system_amount: systemVal,
                    cash_amount: cashTotal,
                    memo: memo
                })
            });

            alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            loadHistory(); // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        }

        // â˜…å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory() {
            const res = await fetch('/api/registers');
            const data = await res.json();
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                // å·®é¡ã®è‰²ä»˜ã‘ç”¨
                let colorStyle = 'color: green;';
                if(row.difference > 0) colorStyle = 'color: blue; font-weight:bold;';
                if(row.difference < 0) colorStyle = 'color: red; font-weight:bold;';

                tr.innerHTML = `
                    <td>${row.date}<br><small style="color:#666">${row.memo || ''}</small></td>
                    <td style="${colorStyle}">${row.difference}</td>
                    <td>${row.cash_amount.toLocaleString()}</td>
                    <td><button class="del-btn" onclick="deleteRecord(${row.id})">å‰Šé™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // â˜…å‰Šé™¤å‡¦ç†
        async function deleteRecord(id) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await fetch(`/api/registers/${id}`, { method: 'DELETE' });
            loadHistory();
        }
    </script>
</body>
</html>